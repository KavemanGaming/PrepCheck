rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function signedIn() { return request.auth != null; }
    function uid() { return request.auth.uid; }
    function isAdmin() {
      return signedIn() && (
        request.auth.token.admin == true ||
        get(/databases/$(database)/documents/users/$(uid())).data.isAdmin == true ||
        get(/databases/$(database)/documents/users/$(uid())).data.roles.admin == true
      );
    }

    // Settings
    match /settings/{docId} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    // Users + tokens
    match /users/{userId} {
      allow read, create, update: if signedIn() && userId == uid();
      allow delete: if isAdmin();

      match /tokens/{tokenId} {
        allow read, create, update, delete: if signedIn() && userId == uid();
      }
    }

    // Lists + Items (primary path)
    match /lists/{listId} {
      // Dev-friendly: let any signed-in user read/write (tighten later)
      allow read, create, update, delete: if signedIn();
      match /items/{itemId} {
        allow read, create, update, delete: if signedIn();
      }
    }

    // Legacy/alternate path used by admin_page (covered just in case)
    match /inventory_lists/{listId} {
      allow read, create, update, delete: if signedIn();
      match /items/{itemId} {
        allow read, create, update, delete: if signedIn();
      }
    }

    // Orders (keep write to admins only unless you want users to create)
    match /orders/{orderId} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    // --- Multi-tenant scheduling/timeclock (new) ---
    // Dynamic path helpers must use literal path interpolation; get()/exists()
    // cannot accept string paths.
    function isTenantMember(businessId) {
      return signedIn() && exists(/databases/$(database)/documents/businessMembers/$(businessId)/users/$(uid()));
    }
    function tenantRole(businessId) {
      return get(/databases/$(database)/documents/businessMembers/$(businessId)/users/$(uid())).data.role;
    }
    function isOwner(businessId) { return isTenantMember(businessId) && tenantRole(businessId) == 'owner'; }
    function isOwnerOrManager(businessId) { return isTenantMember(businessId) && (tenantRole(businessId) in ['owner','manager']); }

    match /businesses/{businessId} {
      allow read: if isTenantMember(businessId);
      allow create: if signedIn() && request.resource.data.ownerId == uid();
      allow update, delete: if isOwner(businessId);

      match /locations/{locationId} {
        allow read: if isTenantMember(businessId);
        allow create, update, delete: if isOwnerOrManager(businessId);
      }

      match /roles/{roleId} {
        allow read: if isTenantMember(businessId);
        allow create, update, delete: if isOwnerOrManager(businessId);
      }

      match /shifts/{shiftId} {
        allow read: if isOwnerOrManager(businessId) || (isTenantMember(businessId) && resource.data.userId == uid());
        allow create, update, delete: if isOwnerOrManager(businessId);
      }

      match /timesheets/{timesheetId} {
        function staffCreate() {
          return isTenantMember(businessId) && tenantRole(businessId) == 'staff' && request.resource.data.userId == uid();
        }
        function staffUpdate() {
          return isTenantMember(businessId) && tenantRole(businessId) == 'staff' && resource.data.userId == uid();
        }
        allow read: if isOwnerOrManager(businessId) || (isTenantMember(businessId) && resource.data.userId == uid());
        allow create: if isOwnerOrManager(businessId) || staffCreate();
        allow update: if isOwnerOrManager(businessId) || staffUpdate();
        allow delete: if isOwnerOrManager(businessId);
      }

      match /invites/{inviteId} {
        function invitedUser() { return request.auth != null && request.auth.token.email == resource.data.email; }
        allow read: if isOwnerOrManager(businessId) || invitedUser();
        allow create, delete: if isOwnerOrManager(businessId);
        allow update: if isOwnerOrManager(businessId) || (invitedUser() && request.resource.data.diff(resource.data).changedKeys().hasOnly(['status']));
      }

      match /posIntegrations/{provider} {
        allow read: if isOwnerOrManager(businessId);
        allow create, update, delete: if isOwner(businessId);
      }
    }

    match /businessMembers/{businessId}/users/{userId} {
      function canBootstrap() {
        return signedIn() && userId == uid() &&
               !exists(/databases/$(database)/documents/businessMembers/$(businessId)/users/$(uid())) &&
               request.resource.data.role == 'owner';
      }
      allow read: if signedIn() && (userId == uid() || isOwnerOrManager(businessId));
      allow create: if isOwnerOrManager(businessId) || canBootstrap();
      allow update, delete: if isOwnerOrManager(businessId);
    }

    // Catch-all: allow reads for signed-in, writes admin only
    match /{document=**} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }
  }
}
